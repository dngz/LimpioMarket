<!DOCTYPE html>
<html>
<head>
    <title>Orden de Compra</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <h1>Orden de Compra</h1>

    <div class="container">
        <div class="form-container">
            <h2>Agregar artículo de aseo</h2>
            <form id="agregar-form" method="post">
                {% csrf_token %}
                <label for="nombre">Producto:</label>
                <input type="text" id="nombre" name="nombre" required><br>
                <label for="cantidad">Cantidad:</label>
                <input type="number" id="cantidad" name="cantidad" required><br>
                <label for="precio">Precio:</label>
                <input type="number" step="0.01" id="precio" name="precio" required><br>
                <button type="submit" name="agregar_producto">+</button>
            </form>
        </div>

        <div class="productos-container">
            <h2>Productos Añadidos</h2>
            <table>
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                    </tr>
                </thead>
                <tbody id="productos-body">
                    <!-- Aquí se agregarán dinámicamente los productos -->
                </tbody>
            </table>
            <div class="total-container">
                <h3>Total:</h3>
                <p id="total-precio">0.00</p>
            </div>
        </div>
    </div>

    <div class="contact-info">
        <h2>Información de Contacto</h2>
        <form id="informacion-form" method="post">
            {% csrf_token %}
            <input type="hidden" id="productos-seleccionados" name="productos_seleccionados">
            <label for="direccion">Dirección:</label>
            <input type="text" id="direccion" name="direccion" required><br>
            <label for="correo">Correo:</label>
            <input type="email" id="correo" name="correo" required><br>
            <label for="rut">RUT:</label>
            <input type="text" id="rut" name="rut" required><br>
            <button type="button" id="confirmar-btn">Confirmar</button>
        </form>
    </div>

    <script>
        // Variable para almacenar los IDs de los productos seleccionados
        var productosSeleccionados = [];
    
        // Función para agregar un producto al carrito y actualizar el campo oculto
        function agregarProducto(id, nombre, cantidad, precio) {
            // Agregar el ID del producto a la lista
            productosSeleccionados.push(id);
    
            // Actualizar el valor del campo oculto con los IDs de los productos seleccionados
            document.getElementById('productos-seleccionados').value = JSON.stringify(productosSeleccionados);
    
            // Agregar el producto a la tabla de productos añadidos
            var row = '<tr><td>' + nombre + '</td><td>' + cantidad + '</td><td>' + precio.toFixed(2) + '</td></tr>';
            $('#productos-body').append(row);
    
            // Actualizar el total del precio
            var total = parseFloat($('#total-precio').text()) + (cantidad * precio);
            $('#total-precio').text(total.toFixed(2));
        }
    
        // Esperar a que el DOM esté cargado
        $(document).ready(function() {
            // Escuchar el evento submit del formulario para agregar productos
            $('#agregar-form').submit(function(event) {
                // Evitar que se envíe el formulario de manera tradicional
                event.preventDefault();
    
                // Realizar una solicitud AJAX para agregar el producto
                $.ajax({
                    type: 'POST',
                    url: $(this).attr('action'),
                    data: $(this).serialize(),
                    dataType: 'json',
                    success: function(response) {
                        // Verificar si la respuesta contiene datos válidos
                        if (response && response.id !== undefined && response.nombre !== undefined && response.cantidad !== undefined && response.precio !== undefined) {
                            // Llamar a la función para agregar el producto a la tabla
                            agregarProducto(response.id, response.nombre, response.cantidad, response.precio);
                        } else {
                            // Mostrar un mensaje de error si la respuesta no es válida
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Ha ocurrido un error al agregar el producto.'
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        // Mostrar un mensaje de error si ocurre un error en la solicitud AJAX
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Ha ocurrido un error al procesar la solicitud.'
                        });
                    }
                });
            });
        });
    
    </script>
</body>
</html>
